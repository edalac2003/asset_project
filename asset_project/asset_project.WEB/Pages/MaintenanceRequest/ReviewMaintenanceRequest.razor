@page "/maintenance/review"
@using System.Net;
@inject IRepository repository
@inject NavigationManager navigationManager
@inject SweetAlertService sweetAlertService

<div class="col-lg-12 grid-margin">
    <div class="card col-lg-12 mx-auto">
        <div class="card-body px-2 py-2">
            <form class="form-sample">
                <div class="container">
                    <div class="row">
                        <h4 class="card-title">Registro Solicitudes de Mantenimiento </h4>
                        <div class="col-lg-12">
                            <div class="form-group">
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <label>Solicitante</label>
                                        <select class="form-control">
                                            <option selected>-- Seleccione --</option>
                                            <option value="1">Solicitante 1</option>
                                            <option value="1">Solicitante 2</option>
                                            <option value="1">Solicitante 3</option>
                                            <option value="1">Solicitante 4</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <p>Solicitudes registradas</p>
                                    <div class="container-scroller">
                                        <div class="table-responsive table-wrapper-scroll-y my-custom-scrollbar">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th style="width:15%">Fecha registro</th>
                                                        <th style="width:20%">Código Activo</th>
                                                        <th style="width:45%">Activo Fijo</th>
                                                        <th style="width:15%">Estado</th>
                                                        <th style="width:10%"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (listMaintenance != null)
                                                    {
                                                        @foreach (var maintenance in listMaintenance!)
                                                        {
                                                            <tr>
                                                                <td><small>@maintenance.RegisterDate</small> </td>
                                                                <td><small>@maintenance.Asset!.Code</small></td>
                                                                <td><small>@maintenance.Asset!.AssetType?.Name</small></td>
                                                                <td><small>@maintenance.StatusType?.Name</small></td>
                                                                <td>
                                                                    <button class="btn btn-outline-secondary" @onclick=@(() => viewDetail(maintenance.Id))>Detalle</button>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@code {
    private List<MaintenanceRequest>? listMaintenance = null!;
    private string userName = string.Empty;

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        var authenticationState = await authenticationStateTask;
        var claims = authenticationState.User.Claims.ToList();
        userName = authenticationState.User.Identity!.Name;
        await LoadMaintenanceRequest();
    }

    private async Task LoadMaintenanceRequest()
    {
        var responseHttp = await repository.GetAsync<List<MaintenanceRequest>>($"/api/MaintenanceRequest/FindAll/{userName}");
        if (responseHttp.Error)
        {
            if (responseHttp.HttpResponseMessage.StatusCode == HttpStatusCode.NotFound)
            {
                navigationManager.NavigateTo("/");
            }

            var message = await responseHttp.GetErrorMessageAsync();
            //await sweetAlertService.FireAsync("Error", message, SweetAlertIcon.Error);
            return;
        }

        listMaintenance = responseHttp.Response!;
    }



    private void viewDetail(int id)
    {
        navigationManager.NavigateTo($"/maintenance/edit/{id}");
    }
}
